<!DOCTYPE html>
<!--
****************************************************************************
  ATTENTION: DO NOT CHANGE ANYTHING IN THIS FILE UNLESS I EXPLICITLY ASK!!
  Only implement precisely what I request. Do not remove or alter other
  sections without explicit direction. Unexpected changes break my workflow.
****************************************************************************
-->
<html>
<head>
  <meta charset="UTF-8" />
  <title>BORED CHORD 4D</title>
  <link href="https://fonts.googleapis.com/css2?family=Martian+Mono:wght@100;200;300;400;500;600;700;800;900&display=swap" rel="stylesheet">

  <style>
    :root {
      /* Color Palette */
      --background: #141214;/*off-black*/
      --primary: #FBF6E4;/*off-white*/
      --primary-accent: #E2DDCD;/*darker off-white*/
      --secondary: #DC143C;/*red*/
      --secondary-accent: #00FF7E;/*spring green*/
      --black-accent: #393737;/*dark grey*/
      
      /* Layout properties */
      --slider-width: 200px;
      --auto-width: 35px;
    }
    h4 {
      font-family: 'Martian Mono', monospace;
      font-weight: 600;
      font-size: 3.1em;
    }
    .section h4 {
      margin-bottom: 25px; /* Adjust as needed */
    }
    body {
      background: var(--background);
      margin: 0;
      overflow: hidden;
      color: var(--primary-accent);
      font-family: 'Martian Mono', monospace;
      font-weight: 200;
      font-size: 1em;
    }
    .wireframe-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .autoMaster {
      -webkit-appearance: none;
      appearance: none;
      width: var(--auto-width);
      height: var(--auto-width);
      cursor: pointer;
      position: relative;
      background-color: var(--primary);
    }
    .autoMaster:checked::before {
      content: "";
      display: block;
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: url(data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0idXRmLTgiPz4KPCEtLSBHZW5lcmF0b3I6IEFkb2JlIElsbHVzdHJhdG9yIDI3LjAuMCwgU1ZHIEV4cG9ydCBQbHVnLUluIC4gU1ZHIFZlcnNpb246IDYuMDAgQnVpbGQgMCkgIC0tPgo8c3ZnIHZlcnNpb249IjEuMSIgaWQ9IkxheWVyXzEiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgeG1sbnM6eGxpbms9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkveGxpbmsiIHg9IjBweCIgeT0iMHB4IgoJIHZpZXdCb3g9IjAgMCAxMjAuOCA5OS4zIiBzdHlsZT0iZW5hYmxlLWJhY2tncm91bmQ6bmV3IDAgMCAxMjAuOCA5OS4zOyIgeG1sOnNwYWNlPSJwcmVzZXJ2ZSI+CjxwYXRoIGQ9Ik02My4xLDk5LjNWNjkuN0gwdi00MGg2My4xVjBsNTcuNyw0OS43TDYzLjEsOTkuM3oiLz4KPC9zdmc+Cg==) no-repeat center center;
      background-size: contain;
      background-color: var(--secondary-accent);
    }
    
    #controlsLeft, #controlsRight {
      width: 400px;
      padding: 15px;
      background: rgba(20, 18, 20, 0.5);
    }
    #controlsLeft { position: fixed; top: 10px; left: 10px; }
    #controlsRight { position: fixed; top: 10px; right: 10px; }
    .section {
      margin: 0;
      padding: 10px 0; 
      border-bottom: 10px solid var(--black-accent);
    }
    .section:last-child {
      margin-bottom: 0;
      padding-bottom: 0;
      border-bottom: none;
    }
    #controlsLeft label {
      display: grid;
      grid-template-columns: 150px var(--slider-width) auto;
      align-items: center;
      column-gap: 10px;
      margin-bottom: 20px;
      min-height: 50px;
    }
    #freqSection label.preset {
      grid-template-columns: 150px auto;
    }
    #controlsRight .autoLabel {
      display: grid;
      grid-template-columns: var(--auto-width) var(--slider-width) 150px;
      align-items: center;
      column-gap: 10px;
      margin-bottom: 20px;
      min-height: 50px;
    }
    input[type=range], input[type=number] {
      width: 100%;
      box-sizing: border-box;
    }
    #controlsLeft input[type="number"] {
      width: 50%;
      height: 2em;
      border: 5px solid var(--secondary);
      background-color: var(--background);
      color: var(--primary);
      font-size: 1.75em;
      font-weight: 700;
      padding: 0.25em;
      text-align: center;
    }
    #outputSection label.wireframe-row {
      display: flex !important;
      justify-content: space-between;
      align-items: center;
    }
    
    #controlsLeft input[type="number"]::-webkit-inner-spin-button,
    #controlsLeft input[type="number"]::-webkit-outer-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }
    #controlsLeft input[type="number"] { -moz-appearance: textfield; }
    input[type=range] {
      -webkit-appearance: none;
      -moz-appearance: none;
      background: transparent;
      --range-progress: 50%;
      cursor: pointer;
    }
    input[type=range]::-webkit-slider-runnable-track {
      height: 25px;
      border-radius: 15px;
      background: linear-gradient(
        to right,
        var(--secondary) 0%,
        var(--secondary) var(--range-progress),
        var(--primary)   var(--range-progress),
        var(--primary)   100%
      );
    }
    input[type=range]::-webkit-slider-thumb {
      -webkit-appearance: none;
      height: 48px;
      width: 48px;
      border-radius: 50%;
      background: var(--primary-accent);
      border: none;
      margin-top: -11.5px;
      outline: none;
    }
    input[type=range]::-moz-range-track {
      height: 25px;
      border-radius: 15px;
      background: linear-gradient(
        to right,
        var(--secondary) 0%,
        var(--secondary) var(--range-progress),
        var(--primary)   var(--range-progress),
        var(--primary)   100%
      );
    }
    input[type=range]::-moz-range-thumb {
      height: 48px;
      width: 48px;
      border-radius: 50%;
      background: var(--primary-accent);
      border: none;
      margin-top: -11.5px;
      outline: none;
    }
	.saveLoadBtn {
	  display: inline-block;
	  background: var(--secondary); /* Red */
	  color: var(--primary);        /* Off-white */
	  font-family: 'Martian Mono', monospace;
	  font-weight: 500;
	  font-size: 1em;
	  border: none;
	  cursor: pointer;

	  /* Adjust size/spacing as desired */
	  width: 120px;
	  height: 40px;
	  margin: 10px 0;
	}

	/* Optionally add a hover or active style */
	.saveLoadBtn:hover {
	  background: var(--secondary-accent); /* e.g. spring green if you want a highlight */
	  color: var(--background);            /* black-ish text or your choice */
	}
	
    .wave-type-btn {
      width: 50px;
      height: 50px;
      background: var(--secondary);
      color: var(--primary);
      font-family: 'Martian Mono', monospace;
      font-weight: 500;
      border: none; 
      cursor: pointer;
      margin-left: -30px;
    }
    .wave-type-btn[data-wave="off"],
    .wave-type-btn[data-wireframe="off"] {
      background: var(--background); 
      color: var(--secondary);
      border: 3px solid var(--secondary);
    }
    #myCanvas {
      display: block;
    }
  </style>
</head>
<body>
  <!-- TAPER CONFIGS -->
  <script>
    const TAPER_CONFIGS = {
      masterRateSlider:  { min:0.05,  max:.5,   anchorPct:50, anchorVal:0.25 },
      masterRateSlider2: { min:0.5,   max:2,    anchorPct:50, anchorVal:1 },
      volumeSlider:      { min:1,     max:11,   anchorPct:50, anchorVal:5 },
      dtSlider:          { min:1e-5,  max:0.5e-1, anchorPct:20, anchorVal:0.5e-3 },
      numPointsSlider:   { min:100,   max:25000, anchorPct:20, anchorVal:800 },
      saturationSlider:  { min:0,     max:100, anchorPct:0, anchorVal:0 }
    };
    function customTaper(t, config){
      let { min, max, anchorPct, anchorVal } = config;
      let a = anchorPct/100;
      if(a<=0 || a>=1){
        return min + (max-min)* t;
      }
      let e = Math.log((anchorVal-min)/(max-min))/ Math.log(a);
      return min + (max-min)* Math.pow(t, e);
    }
    function getTaperedValue(sliderId){
      const el = document.getElementById(sliderId);
      if(!el) return 0;
      let cfg = TAPER_CONFIGS[sliderId];
      if(!cfg) {
        return parseFloat(el.value);
      }
      let rawVal = parseFloat(el.value);
      let t = rawVal/100;
      return customTaper(t, cfg);
    }
  </script>

  <!-- LEFT TOOLBAR -->
  <div id="controlsLeft">
    <div class="section" id="freqSection">
      <h4>CHORD RATIO</h4>
      <label>
        <span>Freq X:</span>
        <input id="freqX" type="number" value="3" step="0.1">
        <button id="waveTypeX" class="wave-type-btn" data-wave="sine">SINE</button>
      </label>
      <label>
        <span>Freq Y:</span>
        <input id="freqY" type="number" value="4" step="0.1">
        <button id="waveTypeY" class="wave-type-btn" data-wave="sine">SINE</button>
      </label>
      <label>
        <span>Freq Z:</span>
        <input id="freqZ" type="number" value="5" step="0.1">
        <button id="waveTypeZ" class="wave-type-btn" data-wave="sine">SINE</button>
      </label>
      <label>
        <span>Freq W:</span>
        <input id="freqW" type="number" value="6" step="0.1">
        <button id="waveTypeW" class="wave-type-btn" data-wave="sine">SINE</button>
      </label>
      <label class="preset">
        <span>Chord Presets:</span>
        <select id="chordPreset">
          <option value="">--Select Preset--</option>
          <option value="maj7">Major 7</option>
          <option value="min7">Minor 7</option>
          <option value="dom7">Dominant 7</option>
          <option value="dim7">Diminished 7</option>
          <option value="maj6">Major 6</option>
          <option value="min6">Minor 6</option>
          <option value="hdim7">Half Diminished 7</option>
          <option value="minmaj7">Minor Major 7</option>
          <option value="minb6">Minor Flat 6</option>
          <option value="augmaj7">Augmented Major 7</option>
        </select>
      </label>
	  
	<div id="saveLoadSection" class="section">
	  <button id="saveSettings" class="saveLoadBtn">Save Settings</button>
	  <button id="loadSettings" class="saveLoadBtn">Load Settings</button>
	  <input type="file" id="loadSettingsFile" accept="application/json" style="display:none" />
	</div>
  	
	
    </div>
    
    <div class="section" id="lfoSection">
      <h4>LFOs</h4>
      <label>
        <span>LFO #1 (Hz): <span id="masterRateVal">.5</span></span>
        <input id="masterRateSlider" type="range" min="0" max="100" step="0.5" value="1">
        <input id="masterRateToggle1" type="checkbox" class="autoMaster" checked>
      </label>
      <label>
        <span>LFO #2 (Hz): <span id="masterRateVal2">1</span></span>
        <input id="masterRateSlider2" type="range" min="0" max="100" step="0.5" value="25">
        <input id="masterRateToggle2" type="checkbox" class="autoMaster">
      </label>
    </div>

    <div class="section" id="outputSection">
      <h4>OUTPUT</h4>
      <label>
        <span>Volume: <span id="volVal">5</span></span>
        <input id="volumeSlider" type="range" min="0" max="100" step="0.5" value="75">
      </label>
      <label>
        <span>Δt per Point: <span id="dtVal"></span></span>
        <input id="dtSlider" type="range" min="0" max="100" step="0.5" value="40">
      </label>
      <label>
        <span># Points: <span id="numPointsVal"></span></span>
        <input id="numPointsSlider" type="range" min="0" max="100" step="0.5" value="65">
      </label>
      <label>
        <span>Curve Color: <span id="saturationVal"></span></span>
        <input id="saturationSlider" type="range" min="0" max="100" step="0.5" value="0">
      </label>
      <label class="wireframe-row">
        <span>4D Spacial Wireframe:</span>
        <button id="wireframeBtn" class="wave-type-btn" data-wireframe="off">OFF</button>
      </label>
    </div>
  </div>

  <!-- RIGHT TOOLBAR -->
  <div id="controlsRight">
    <div class="section" id="phaseSection">
      <h4>PHASE SHIFT</h4>
      <div class="autoLabel">
        <span class="rightAuto">
          <input id="phaseXAuto" type="checkbox" class="autoMaster" data-target="phaseXRange" checked>
        </span>
        <span class="rightSlider">
          <input id="phaseXRange" type="range" min="0" max="6.283185307179586" step="any" value="0">
        </span>
        <span class="rightLabel">X PHASE: <span id="phaseXVal">0</span>°</span>
      </div>
      <div class="autoLabel">
        <span class="rightAuto">
          <input id="phaseYAuto" type="checkbox" class="autoMaster" data-target="phaseYRange">
        </span>
        <span class="rightSlider">
          <input id="phaseYRange" type="range" min="0" max="6.283185307179586" step="any" value="0">
        </span>
        <span class="rightLabel">Y PHASE: <span id="phaseYVal">0</span>°</span>
      </div>
      <div class="autoLabel">
        <span class="rightAuto">
          <input id="phaseZAuto" type="checkbox" class="autoMaster" data-target="phaseZRange">
        </span>
        <span class="rightSlider">
          <input id="phaseZRange" type="range" min="0" max="6.283185307179586" step="any" value="0">
        </span>
        <span class="rightLabel">Z PHASE: <span id="phaseZVal">0</span>°</span>
      </div>
      <div class="autoLabel">
        <span class="rightAuto">
          <input id="phaseWAuto" type="checkbox" class="autoMaster" data-target="phaseWRange">
        </span>
        <span class="rightSlider">
          <input id="phaseWRange" type="range" min="0" max="6.283185307179586" step="any" value="0">
        </span>
        <span class="rightLabel">W PHASE: <span id="phaseWVal">0</span>°</span>
      </div>
    </div>
    
    <div class="section" id="rot3DSection">
      <h4>3D ROTATION</h4>
      <div class="autoLabel">
        <span class="rightAuto">
          <input id="rotXAuto" type="checkbox" class="autoMaster" data-target="rotXRange">
        </span>
        <span class="rightSlider">
          <input id="rotXRange" type="range" min="0" max="6.283185307179586" step="any" value="0">
        </span>
        <span class="rightLabel">X Axis: <span id="rotXVal">0</span>°</span>
      </div>
      <div class="autoLabel">
        <span class="rightAuto">
          <input id="rotYAuto" type="checkbox" class="autoMaster" data-target="rotYRange">
        </span>
        <span class="rightSlider">
          <input id="rotYRange" type="range" min="0" max="6.283185307179586" step="any" value="0">
        </span>
        <span class="rightLabel">Y Axis: <span id="rotYVal">0</span>°</span>
      </div>
      <div class="autoLabel">
        <span class="rightAuto">
          <input id="rotZAuto" type="checkbox" class="autoMaster" data-target="rotZRange">
        </span>
        <span class="rightSlider">
          <input id="rotZRange" type="range" min="0" max="6.283185307179586" step="any" value="0">
        </span>
        <span class="rightLabel">Z Axis: <span id="rotZVal">0</span>°</span>
      </div>
    </div>
    
    <div class="section" id="rot4DSection">
      <h4>4D ROTATION</h4>
      <div class="autoLabel">
        <span class="rightAuto">
          <input id="angle4DXYAuto" type="checkbox" class="autoMaster" data-target="angle4DXYRange">
        </span>
        <span class="rightSlider">
          <input id="angle4DXYRange" type="range" min="0" max="6.283185307179586" step="any" value="0">
        </span>
        <span class="rightLabel">XY Plane: <span id="angle4DXYVal">0</span>°</span>
      </div>
      <div class="autoLabel">
        <span class="rightAuto">
          <input id="angle4DXZAuto" type="checkbox" class="autoMaster" data-target="angle4DXZRange">
        </span>
        <span class="rightSlider">
          <input id="angle4DXZRange" type="range" min="0" max="6.283185307179586" step="any" value="0">
        </span>
        <span class="rightLabel">XZ Plane: <span id="angle4DXZVal">0</span>°</span>
      </div>
      <div class="autoLabel">
        <span class="rightAuto">
          <input id="angle4DXWAuto" type="checkbox" class="autoMaster" data-target="angle4DXWRange">
        </span>
        <span class="rightSlider">
          <input id="angle4DXWRange" type="range" min="0" max="6.283185307179586" step="any" value="0">
        </span>
        <span class="rightLabel">XW Plane: <span id="angle4DXWVal">0</span>°</span>
      </div>
      <div class="autoLabel">
        <span class="rightAuto">
          <input id="angle4DYZAuto" type="checkbox" class="autoMaster" data-target="angle4DYZRange">
        </span>
        <span class="rightSlider">
          <input id="angle4DYZRange" type="range" min="0" max="6.283185307179586" step="any" value="0">
        </span>
        <span class="rightLabel">YZ Plane: <span id="angle4DYZVal">0</span>°</span>
      </div>
      <div class="autoLabel">
        <span class="rightAuto">
          <input id="angle4DYWAuto" type="checkbox" class="autoMaster" data-target="angle4DYWRange">
        </span>
        <span class="rightSlider">
          <input id="angle4DYWRange" type="range" min="0" max="6.283185307179586" step="any" value="0">
        </span>
        <span class="rightLabel">YW Plane: <span id="angle4DYWVal">0</span>°</span>
      </div>
      <div class="autoLabel">
        <span class="rightAuto">
          <input id="angle4DZWAuto" type="checkbox" class="autoMaster" data-target="angle4DZWRange">
        </span>
        <span class="rightSlider">
          <input id="angle4DZWRange" type="range" min="0" max="6.283185307179586" step="any" value="0">
        </span>
        <span class="rightLabel">ZW Plane: <span id="angle4DZWVal">0</span>°</span>
      </div>
    </div>
  </div>

  <canvas id="myCanvas"></canvas>

  <script>
    /********************************************************
     * Wave Toggles
     ********************************************************/
    document.querySelectorAll('.wave-type-btn').forEach(btn=>{
      btn.addEventListener('click',()=>{
        let curr = btn.dataset.wave;
        if(curr === 'off'){
          // from off to sine
          btn.dataset.wave = 'sine'; 
          btn.textContent = 'SINE';
          btn.style.background = 'var(--secondary)';
          btn.style.color = 'var(--primary)';
          btn.style.border = 'none';
        } else if(curr === 'sine'){
          // from sine to triangle
          btn.dataset.wave = 'triangle'; 
          btn.textContent = 'TRI.';
          btn.style.background = 'var(--secondary)';
          btn.style.color = 'var(--primary)';
          btn.style.border = 'none';
        } else if(curr === 'triangle'){
          // from triangle to off
          btn.dataset.wave = 'off'; 
          btn.textContent = 'OFF';
          btn.style.background = 'var(--background)';
          btn.style.color = 'var(--secondary)';
          btn.style.border = '3px solid var(--secondary)';
        }
      });
    });

    /********************************************************
     * Wireframe ON/OFF button logic, similar style
     ********************************************************/
    const wireframeBtn = document.getElementById('wireframeBtn');
    wireframeBtn.addEventListener('click', () => {
      let curr = wireframeBtn.dataset.wireframe;
      if (curr === 'off') {
        // turn ON
        wireframeBtn.dataset.wireframe = 'on';
        wireframeBtn.textContent = 'ON';
        wireframeBtn.style.background = 'var(--secondary)';
        wireframeBtn.style.color = 'var(--primary)';
        wireframeBtn.style.border = 'none';
      } else {
        // turn OFF
        wireframeBtn.dataset.wireframe = 'off';
        wireframeBtn.textContent = 'OFF';
        wireframeBtn.style.background = 'var(--background)';
        wireframeBtn.style.color = 'var(--secondary)';
        wireframeBtn.style.border = '3px solid var(--secondary)';
      }
    });

    function radToDeg(rad){ return (rad*180)/Math.PI; }

    /********************************************************
     * Rotation sliders => dataset.phase
     ********************************************************/
    const rotationSliders = [
      { rangeId:'phaseXRange', valId:'phaseXVal', offset:0 },
      { rangeId:'phaseYRange', valId:'phaseYVal', offset:0 },
      { rangeId:'phaseZRange', valId:'phaseZVal', offset:0 },
      { rangeId:'phaseWRange', valId:'phaseWVal', offset:0 },
      { rangeId:'rotXRange',   valId:'rotXVal',   offset:0 },
      { rangeId:'rotYRange',   valId:'rotYVal',   offset:0 },
      { rangeId:'rotZRange',   valId:'rotZVal',   offset:Math.PI/2 },
      { rangeId:'angle4DXYRange', valId:'angle4DXYVal', offset:0 },
      { rangeId:'angle4DXZRange', valId:'angle4DXZVal', offset:0 },
      { rangeId:'angle4DXWRange', valId:'angle4DXWVal', offset:0 },
      { rangeId:'angle4DYZRange', valId:'angle4DYZVal', offset:0 },
      { rangeId:'angle4DYWRange', valId:'angle4DYWVal', offset:0 },
      { rangeId:'angle4DZWRange', valId:'angle4DZWVal', offset:0 }
    ];
    rotationSliders.forEach(obj=>{
      let slider=document.getElementById(obj.rangeId);
      let label=document.getElementById(obj.valId);
      if(!slider||!label) return;
      slider.addEventListener('input', e=>{
        let val=parseFloat(e.target.value);
        slider.dataset.phase=val;
        let eff=(val+obj.offset)%(2*Math.PI);
        label.textContent=radToDeg(eff).toFixed(0);
      });
      slider.dispatchEvent(new Event('input'));
    });

    /********************************************************
     * Freq & LFO sliders
     ********************************************************/
    const freqXInput=document.getElementById("freqX");
    const freqYInput=document.getElementById("freqY");
    const freqZInput=document.getElementById("freqZ");
    const freqWInput=document.getElementById("freqW");

    const masterRateSlider=document.getElementById("masterRateSlider");
    const masterRateVal=document.getElementById("masterRateVal");
    const masterRateToggle1=document.getElementById("masterRateToggle1");
    masterRateSlider.addEventListener("input",()=>{
      let freq=getTaperedValue("masterRateSlider");
      masterRateVal.textContent=freq.toFixed(2);
    });
    masterRateSlider.dispatchEvent(new Event('input'));

    const masterRateSlider2=document.getElementById("masterRateSlider2");
    const masterRateVal2=document.getElementById("masterRateVal2");
    const masterRateToggle2=document.getElementById("masterRateToggle2");
    masterRateSlider2.addEventListener("input",()=>{
      let freq2=getTaperedValue("masterRateSlider2");
      masterRateVal2.textContent=freq2.toFixed(2);
    });
    masterRateSlider2.dispatchEvent(new Event('input'));

    const volumeSlider=document.getElementById("volumeSlider");
    const volVal=document.getElementById("volVal");
    volumeSlider.addEventListener("input",()=>{
      let v=getTaperedValue("volumeSlider");
      volVal.textContent=v.toFixed(2);
    });
    volumeSlider.dispatchEvent(new Event('input'));

    const dtSlider=document.getElementById("dtSlider");
    const dtVal=document.getElementById("dtVal");
    dtSlider.addEventListener("input",()=>{
      let dt=getTaperedValue("dtSlider");
      dtVal.textContent=dt.toExponential(2);
      buildTimeArray();
    });
    dtSlider.dispatchEvent(new Event('input'));

    const numPointsSlider=document.getElementById("numPointsSlider");
    const numPointsVal=document.getElementById("numPointsVal");
    numPointsSlider.addEventListener("input",()=>{
      let val=getTaperedValue("numPointsSlider");
      let n=Math.round(val);
      numPointsVal.textContent=n;
      buildTimeArray();
    });
    numPointsSlider.dispatchEvent(new Event('input'));

    const saturationSlider=document.getElementById("saturationSlider");
    const saturationVal=document.getElementById("saturationVal");
    saturationSlider.addEventListener("input",()=>{
      let s=getTaperedValue("saturationSlider");
      saturationVal.textContent=s.toFixed(0);
    });
    saturationSlider.dispatchEvent(new Event('input'));

    let timeArray=[];
    function buildTimeArray(){
      timeArray=[];
      let nPoints=Math.round(getTaperedValue("numPointsSlider"));
      let dt=getTaperedValue("dtSlider");
      for(let i=0;i<nPoints;i++){
        timeArray.push(i*dt);
      }
    }
    buildTimeArray();

    // wave helper
    function triangleWave(x){
      return (2/Math.PI)*Math.asin(Math.sin(x));
    }
    function getWaveValue(wave,angle){
      if(wave==='off') return 0;
      if(wave==='triangle') return triangleWave(angle);
      return Math.sin(angle);
    }

    /********************************************************
     * EXACT old rotateXYZ mismatch
     ********************************************************/
    function rotateX(x,y,z,ax){
      let c=Math.cos(ax), s=Math.sin(ax);
      return { x, y:y*c - z*s, z:y*s+z*c };
    }
    function rotateY(x,y,z,ay){
      let c=Math.cos(ay), s=Math.sin(ay);
      return { x:z*s + x*c, y, z:z*c - x*s };
    }
    function rotateZ(x,y,z,az){
      let c=Math.cos(az), s=Math.sin(az);
      return { x:x*c - y*s, y:x*s + y*c, z };
    }
    function rotateXYZ(x,y,z,ax,ay,az){
      let r=rotateX(x,y,z,ax);
      r=rotateY(r.x,r.y,r.z,ay);
      r=rotateZ(r.x,r.y,r.z,az);
      return r;
    }

    // 4D rotation
    function rotateXY(v,t){
      let c=Math.cos(t), s=Math.sin(t);
      return { x:v.x*c - v.y*s, y:v.x*s + v.y*c, z:v.z, w:v.w };
    }
    function rotateXZ(v,t){
      let c=Math.cos(t), s=Math.sin(t);
      return { x:v.x*c - v.z*s, y:v.y, z:v.x*s+v.z*c, w:v.w };
    }
    function rotateXW(v,t){
      let c=Math.cos(t), s=Math.sin(t);
      return { x:v.x*c - v.w*s, y:v.y, z:v.z, w:v.x*s+v.w*c };
    }
    function rotateYZ(v,t){
      let c=Math.cos(t), s=Math.sin(t);
      return { x:v.x, y:v.y*c - v.z*s, z:v.y*s+v.z*c, w:v.w };
    }
    function rotateYW(v,t){
      let c=Math.cos(t), s=Math.sin(t);
      return { x:v.x, y:v.y*c - v.w*s, z:v.z, w:v.y*s+v.w*c };
    }
    function rotateZW(v,t){
      let c=Math.cos(t), s=Math.sin(t);
      return { x:v.x, y:v.y, z:v.z*c - v.w*s, w:v.z*s+v.w*c };
    }

    /********************************************************
     * Automated slider updates
     ********************************************************/
    function updateAutomatedSliders(deltaTime,speed){
      const twoPi=2*Math.PI;
      document.querySelectorAll('.autoMaster').forEach(auto=>{
        if(auto.checked){
          let targetId=auto.dataset.target;
          let slider=document.getElementById(targetId);
          if(slider){
            let minVal=parseFloat(slider.min), maxVal=parseFloat(slider.max);
            let range=maxVal-minVal;
            if(Math.abs(range-twoPi)<1e-5){
              let phase=parseFloat(slider.dataset.phase||slider.value);
              phase+=speed*deltaTime;
              slider.dataset.phase=phase;
              let wrapped=((phase-minVal)%range+range)%range+minVal;
              slider.value=wrapped;
              slider.dispatchEvent(new Event('input'));
            } else {
              let curVal=parseFloat(slider.value);
              let newVal=curVal+speed*deltaTime;
              if(newVal>maxVal) newVal=maxVal;
              if(newVal<minVal) newVal=minVal;
              slider.value=newVal;
              slider.dispatchEvent(new Event('input'));
            }
          }
        }
      });
    }
    function getContinuousAngle(sliderId,offset=0){
      let slider=document.getElementById(sliderId);
      if(!slider) return offset;
      let phase=parseFloat(slider.dataset.phase||slider.value);
      return phase+offset;
    }

    // Canvas
    const canvas=document.getElementById("myCanvas");
    const ctx=canvas.getContext("2d");
    function resizeCanvas(){
      canvas.width=window.innerWidth;
      canvas.height=window.innerHeight;
    }
    window.addEventListener('resize',resizeCanvas);
    resizeCanvas();

    // Build hypercube & 3D-cube
    const hypercubeVertices=[];
    for(let i=0;i<16;i++){
      hypercubeVertices.push({
        x:(i&1)?1:-1,
        y:(i&2)?1:-1,
        z:(i&4)?1:-1,
        w:(i&8)?1:-1
      });
    }
    const hypercubeEdges=[];
    for(let i=0;i<16;i++){
      for(let bit=0;bit<4;bit++){
        let j=i^(1<<bit);
        if(j>i) hypercubeEdges.push([i,j]);
      }
    }
    const cube3DVertices=[
      {x:-1,y:-1,z:-1,w:0},
      {x:1,y:-1,z:-1,w:0},
      {x:1,y:1,z:-1,w:0},
      {x:-1,y:1,z:-1,w:0},
      {x:-1,y:-1,z:1,w:0},
      {x:1,y:-1,z:1,w:0},
      {x:1,y:1,z:1,w:0},
      {x:-1,y:1,z:1,w:0}
    ];
    const cube3DEdges=[
      [0,1],[1,2],[2,3],[3,0],
      [4,5],[5,6],[6,7],[7,4],
      [0,4],[1,5],[2,6],[3,7]
    ];

    // The wireframe draw function
    function drawWireframe(ax,ay,az,aXY,aXZ,aXW,aYZ,aYW,aZW,camZ){
      ctx.save();
      ctx.lineWidth=1; 
      ctx.setLineDash([4,4]);
      ctx.strokeStyle="rgba(251,246,228,0.5)";
      let hProj=[];
      for(let v of hypercubeVertices){
        let r=rotateXY(v,aXY);
        r=rotateXZ(r,aXZ);
        r=rotateXW(r,aXW);
        r=rotateYZ(r,aYZ);
        r=rotateYW(r,aYW);
        r=rotateZW(r,aZW);

        let d4=5;
        let factor4=d4/(d4-r.w);
        let x3=r.x*factor4;
        let y3=r.y*factor4;
        let z3=r.z*factor4;
        let {x: xr,y: yr,z: zr}=rotateXYZ(x3,y3,z3,ay,ax,az);

        let denom=camZ-zr;
        if(Math.abs(denom)<1e-5) denom=1e-5;
        let scale=Math.min(canvas.width,canvas.height)*0.45;
        let px=canvas.width*0.5+(xr/denom)*scale;
        let py=canvas.height*0.5-(yr/denom)*scale;
        hProj.push({x:px,y:py});
      }
      for(let [start,end] of hypercubeEdges){
        let A=hProj[start], B=hProj[end];
        ctx.beginPath();
        ctx.moveTo(A.x,A.y);
        ctx.lineTo(B.x,B.y);
        ctx.stroke();
      }
      ctx.restore();

      ctx.save();
      ctx.lineWidth=2;
      ctx.setLineDash([]);
      ctx.strokeStyle="rgba(251,246,228,0.5)";
      let cProj=[];
      for(let v of cube3DVertices){
        let r=rotateXY(v,aXY);
        r=rotateXZ(r,aXZ);
        r=rotateXW(r,aXW);
        r=rotateYZ(r,aYZ);
        r=rotateYW(r,aYW);
        r=rotateZW(r,aZW);

        let d4=5;
        let factor4=d4/(d4-r.w);
        let x3=r.x*factor4;
        let y3=r.y*factor4;
        let z3=r.z*factor4;
        let {x: xr,y: yr,z: zr}=rotateXYZ(x3,y3,z3,ay,ax,az);

        let denom=camZ-zr;
        if(Math.abs(denom)<1e-5) denom=1e-5;
        let scale=Math.min(canvas.width,canvas.height)*0.45;
        let px=canvas.width*0.5+(xr/denom)*scale;
        let py=canvas.height*0.5-(yr/denom)*scale;
        cProj.push({x:px,y:py});
      }
      for(let [start,end] of cube3DEdges){
        let A=cProj[start], B=cProj[end];
        ctx.beginPath();
        ctx.moveTo(A.x,A.y);
        ctx.lineTo(B.x,B.y);
        ctx.stroke();
      }
      ctx.restore();
    }

    let lastFrameTime=performance.now();
    function drawFrame(now){
      let deltaTime=(now-lastFrameTime)*0.001;
      lastFrameTime=now;
      ctx.clearRect(0,0,canvas.width,canvas.height);

      // LFO freq
      const lfo1=masterRateToggle1.checked, lfo2=masterRateToggle2.checked;
      let f1=getTaperedValue("masterRateSlider");
      let f2=getTaperedValue("masterRateSlider2");
      let effFreq;
      if(lfo1&&!lfo2) effFreq=f1;
      else if(!lfo1&&lfo2) effFreq=f2;
      else if(lfo1&&lfo2){
        effFreq=f1*(1+0.5*Math.sin(2*Math.PI*f2*(now*0.001)));
      } else effFreq=0;

      const speed=2*Math.PI*effFreq;
      updateAutomatedSliders(deltaTime,speed);

      let fx=parseFloat(freqXInput.value)||3;
      let fy=parseFloat(freqYInput.value)||4;
      let fz=parseFloat(freqZInput.value)||5;
      let fw=parseFloat(freqWInput.value)||6;

      // read 4D phases
      let phx=getContinuousAngle("phaseXRange");
      let phy=getContinuousAngle("phaseYRange");
      let phz=getContinuousAngle("phaseZRange");
      let phw=getContinuousAngle("phaseWRange");

      // read 3D angles
      let ax=getContinuousAngle("rotXRange");
      let ay=getContinuousAngle("rotYRange");
      let rawAz=getContinuousAngle("rotZRange");
      let az=rawAz+Math.PI/2; // your old offset

      let vol=getTaperedValue("volumeSlider")||5;
      let camZ=5-0.4*(vol-1);

      let n=timeArray.length;

      let waveX=document.getElementById("waveTypeX").dataset.wave;
      let waveY=document.getElementById("waveTypeY").dataset.wave;
      let waveZ=document.getElementById("waveTypeZ").dataset.wave;
      let waveW=document.getElementById("waveTypeW").dataset.wave;

      // read 4D angles
      let aXY=getContinuousAngle("angle4DXYRange");
      let aXZ=getContinuousAngle("angle4DXZRange");
      let aXW=getContinuousAngle("angle4DXWRange");
      let aYZ=getContinuousAngle("angle4DYZRange");
      let aYW=getContinuousAngle("angle4DYWRange");
      let aZW=getContinuousAngle("angle4DZWRange");

      let alphaFrac=getTaperedValue("saturationSlider")/100;

      // MAIN wave
      for(let i=0;i<n;i++){
        let t=timeArray[i];
        let angleX=2*Math.PI*fx*t + phx;
        let angleY=2*Math.PI*fy*t + phy;
        let angleZ=2*Math.PI*fz*t + phz;
        let angleW=2*Math.PI*fw*t + phw;

        let x4=getWaveValue(waveX,angleX);
        let y4=getWaveValue(waveY,angleY);
        let z4=getWaveValue(waveZ,angleZ);
        let w4=getWaveValue(waveW,angleW);

        let v4={ x:x4, y:y4, z:z4, w:w4 };
        v4=rotateXY(v4,aXY);
        v4=rotateXZ(v4,aXZ);
        v4=rotateXW(v4,aXW);
        v4=rotateYZ(v4,aYZ);
        v4=rotateYW(v4,aYW);
        v4=rotateZW(v4,aZW);

        let allZero4D=(aXW===0&&aYW===0&&aZW===0);
        let effW=allZero4D?0:v4.w;
        let d4=5;
        let factor4=d4/(d4-effW);
        let x3=v4.x*factor4;
        let y3=v4.y*factor4;
        let z3=v4.z*factor4;

        // mismatch param => rotateXYZ(..., ay, ax, az)
        let { x: xr, y: yr, z: zr }=rotateXYZ(x3,y3,z3,ay,ax,az);

        let denom=camZ-zr;
        if(Math.abs(denom)<1e-5) continue;
        let scale=Math.min(canvas.width,canvas.height)*0.45;
        let px=canvas.width*0.5+(xr/denom)*scale;
        let py=canvas.height*0.5-(yr/denom)*scale;
        // Removed dynamic pulse-based radius; use a constant:
        let radius = 2;

        let whiteAlpha=1-alphaFrac;
        let hue=(zr+1)*180;
        if(whiteAlpha>0){
          ctx.fillStyle=`rgba(251,246,228,${whiteAlpha})`;
          ctx.beginPath();
          ctx.arc(px,py,radius,0,2*Math.PI);
          ctx.fill();
        }
        ctx.fillStyle=`hsla(${hue},100%,50%,${alphaFrac})`;
        ctx.beginPath();
        ctx.arc(px,py,radius,0,2*Math.PI);
        ctx.fill();
      }

      // If wireframe ON
      if(wireframeBtn.dataset.wireframe==='on'){
        drawWireframe(ax,ay,az,aXY,aXZ,aXW,aYZ,aYW,aZW,camZ);
      }

      requestAnimationFrame(drawFrame);
    }
    requestAnimationFrame(drawFrame);
	
  </script>

  <!-- Slider gradient fill -->
  <script>
    document.querySelectorAll('input[type=range]').forEach(slider=>{
      slider.addEventListener('input',()=>{
        let min=parseFloat(slider.min)||0, max=parseFloat(slider.max)||100;
        let val=parseFloat(slider.value);
        let pct=((val-min)*100/(max-min))+'%';
        slider.style.setProperty('--range-progress',pct);
      });
      slider.dispatchEvent(new Event('input'));
    });
  </script>

  <!-- Chord Preset Dropdown Handling -->
  <script>
    document.getElementById('chordPreset').addEventListener('change',function(){
      const presets={
        maj7:[8,10,12,15],
        min7:[10,12,15,18],
        dom7:[20,25,30,36],
        dim7:[125,150,180,216],
        maj6:[16,20,24,27],
        min6:[80,96,120,135],
        hdim7:[25,30,36,45],
        minmaj7:[40,48,60,75],
        minb6:[10,12,15,16],
        augmaj7:[16,20,25,30]
      };
      const freqIDs=['freqX','freqY','freqZ','freqW'];
      const values=presets[this.value];
      if(values){
        freqIDs.forEach((id,i)=>{
          document.getElementById(id).value=values[i];
        });
      }
      freqIDs.forEach(id=>{
        document.getElementById(id).dispatchEvent(new Event('input'));
      });
    });
  </script>

  <script>
    function scaleToolbar(toolbar){
      const viewportHeight=window.innerHeight;
      const toolbarHeight=toolbar.scrollHeight;
      const scale=Math.min(1,viewportHeight/toolbarHeight);
      toolbar.style.transform=`scale(${scale})`;
      if(toolbar.id==="controlsRight"){
        toolbar.style.transformOrigin="top right";
      } else {
        toolbar.style.transformOrigin="top left";
      }
    }
    const controlsLeft=document.getElementById("controlsLeft");
    const controlsRight=document.getElementById("controlsRight");
    scaleToolbar(controlsLeft);
    scaleToolbar(controlsRight);
    window.addEventListener("resize",()=>{
      scaleToolbar(controlsLeft);
      scaleToolbar(controlsRight);
    });
  </script>
 <script>
 // -- (A) HELPER FUNCTIONS for Wave/Wireframe Button UI -- //
 function updateWaveButtonUI(btn, waveState) {
   // This matches the logic in your wave-type-btn click event:
   btn.dataset.wave = waveState;
   switch (waveState) {
     case 'off':
       btn.textContent = 'OFF';
       btn.style.background = 'var(--background)';
       btn.style.color = 'var(--secondary)';
       btn.style.border = '3px solid var(--secondary)';
       break;
     case 'sine':
       btn.textContent = 'SINE';
       btn.style.background = 'var(--secondary)';
       btn.style.color = 'var(--primary)';
       btn.style.border = 'none';
       break;
     case 'triangle':
       btn.textContent = 'TRI.';
       btn.style.background = 'var(--secondary)';
       btn.style.color = 'var(--primary)';
       btn.style.border = 'none';
       break;
   }
 }

 function updateWireframeButtonUI(btn, wireframeState) {
   // Matches the logic in your wireframeBtn click event:
   btn.dataset.wireframe = wireframeState;
   if (wireframeState === 'on') {
     btn.textContent = 'ON';
     btn.style.background = 'var(--secondary)';
     btn.style.color = 'var(--primary)';
     btn.style.border = 'none';
   } else {
     btn.textContent = 'OFF';
     btn.style.background = 'var(--background)';
     btn.style.color = 'var(--secondary)';
     btn.style.border = '3px solid var(--secondary)';
   }
 }

 // -- (B) GATHER ALL SETTINGS => JSON -- //
 function getSettings() {
   const settings = {};

   // 1) Grab all <input> & <select> from BOTH toolbars
   //    (Ensures we also get phase checkboxes, rotation sliders, etc.)
   const inputs = document.querySelectorAll("#controlsLeft input, #controlsLeft select, #controlsRight input, #controlsRight select");
   inputs.forEach(el => {
     if (el.type === "checkbox") {
       settings[el.id] = el.checked; // on/off
     } else {
       settings[el.id] = el.value;   // numeric or text
     }
   });

   // 2) Include wave‐type and wireframe buttons
   //    Each has a data attribute to save (data-wave or data-wireframe)
   const waveX = document.getElementById("waveTypeX");
   const waveY = document.getElementById("waveTypeY");
   const waveZ = document.getElementById("waveTypeZ");
   const waveW = document.getElementById("waveTypeW");
   const wireB = document.getElementById("wireframeBtn");

   if (waveX) settings.waveTypeXState = waveX.dataset.wave;
   if (waveY) settings.waveTypeYState = waveY.dataset.wave;
   if (waveZ) settings.waveTypeZState = waveZ.dataset.wave;
   if (waveW) settings.waveTypeWState = waveW.dataset.wave;
   if (wireB) settings.wireframeBtnState = wireB.dataset.wireframe;

   return settings;
 }

 // -- (C) APPLY SETTINGS FROM JSON -- //
 function setSettings(settings) {
   // 1) Apply <input> & <select> in both toolbars
   const inputs = document.querySelectorAll("#controlsLeft input, #controlsLeft select, #controlsRight input, #controlsRight select");
   inputs.forEach(el => {
     if (settings.hasOwnProperty(el.id)) {
       if (el.type === "checkbox") {
         el.checked = settings[el.id];
       } else {
         el.value = settings[el.id];
       }
       // Trigger "input" so existing logic refreshes
       el.dispatchEvent(new Event("input"));
     }
   });

   // 2) Apply wave‐type & wireframe states
   const waveX = document.getElementById("waveTypeX");
   const waveY = document.getElementById("waveTypeY");
   const waveZ = document.getElementById("waveTypeZ");
   const waveW = document.getElementById("waveTypeW");
   const wireB = document.getElementById("wireframeBtn");

   if (waveX && settings.waveTypeXState) {
     updateWaveButtonUI(waveX, settings.waveTypeXState);
   }
   if (waveY && settings.waveTypeYState) {
     updateWaveButtonUI(waveY, settings.waveTypeYState);
   }
   if (waveZ && settings.waveTypeZState) {
     updateWaveButtonUI(waveZ, settings.waveTypeZState);
   }
   if (waveW && settings.waveTypeWState) {
     updateWaveButtonUI(waveW, settings.waveTypeWState);
   }
   if (wireB && settings.wireframeBtnState) {
     updateWireframeButtonUI(wireB, settings.wireframeBtnState);
   }
 }

 // -- (D) HOOK UP SAVE / LOAD BUTTONS -- //
 document.getElementById("saveSettings").addEventListener("click", () => {
   // Gather current states
   const settings = getSettings();
   // Convert to a downloadable data URL
   const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(settings, null, 2));
   // Create a temporary link to download
   const downloadAnchor = document.createElement("a");
   downloadAnchor.setAttribute("href", dataStr);
   downloadAnchor.setAttribute("download", "settings.json");
   document.body.appendChild(downloadAnchor);
   downloadAnchor.click();
   downloadAnchor.remove();
 });

 // Clicking "Load Settings" -> triggers hidden file input
 document.getElementById("loadSettings").addEventListener("click", () => {
   document.getElementById("loadSettingsFile").click();
 });

 // On file chosen, read + parse JSON, then apply to UI
 document.getElementById("loadSettingsFile").addEventListener("change", (event) => {
   const file = event.target.files[0];
   if (!file) return;
   const reader = new FileReader();
   reader.onload = (e) => {
     try {
       const settings = JSON.parse(e.target.result);
       setSettings(settings);
     } catch (err) {
       alert("Error parsing JSON:\n" + err);
     }
   };
   reader.readAsText(file);
 });
 </script>
 
 
</body>
</html>
